{% extends "base.html" %}

{% block title %}{{ title }} - Sepet{% endblock %}

{% block content %}
<div class="sidebar-overlay" id="sidebar-overlay"></div>
<div class="product-page-container">
    <aside class="filter-sidebar" id="filter-sidebar">
        <button class="close-sidebar" id="close-sidebar-btn">&times;</button>
        <form action="/products" method="get" class="filter-form">
            <input type="hidden" name="q" value="{{ search_query }}">
            <div class="form-group">
                <label>Marketler</label>
                <div class="checkbox-group">
                    {% for shop in shop_names %}
                        <label class="shop-checkbox-label">
                            <input type="checkbox" name="shops" value="{{ shop }}" {% if shop in selected_shops %}checked{% endif %}>
                            <img src="{{ url_for('static', filename=shop_logo_mapping[shop]) }}" alt="{{ shop }} Logo" class="shop-filter-logo"/>

                        </label>
                    {% endfor %}
                </div>
                <div class="shop-filter-controls">
                    <button type="button" id="toggle-shops-btn" class="btn btn-secondary">Tümünü Seç</button>
                </div>
            </div>
            <div class="form-group">
                <label for="date-range">Tarih Aralığı</label>
                <input type="text" id="date-range" name="date_range" value="{{ start_date }} - {{ end_date }}">
            </div>
            <div class="form-group">
                <label for="category-select" title="Toplamda 140'dan fazla kategori bulunmaktadır.&#10;Arama sonuçları ürünlerin mağazalarda hangi kategori aramalarıyla bulunduğuna göre listelenir.&#10;Bu nedenle, benzer ürünler farklı kategoriler altında görünebilir ve burada arama sonucuna göre filtre edilmiştir.">Kategori</label>
                <select name="category" id="category-select">
                    <option value="all" {% if 'all' == category_name %}selected{% endif %}>Tümü</option>
                    {% for category in food_categories %}
                        <option value="{{ category }}" {% if category == category_name %}selected{% endif %}>{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-actions">
                <input type="submit" value="Filtrele" class="btn btn-primary">
            </div>
        </form>
    </aside>

    <main class="results-main">
        <button class="menu-toggle" id="menu-toggle-btn">Filtreleri Göster</button>
        {% if search_error %}
            <div class="alert alert-danger" role="alert">
                {{ search_error }}
            </div>
        {% endif %}
        {% if charts_data %}
            <h2>{{ results_title }}</h2>
            <p class="date-range">{{ start_date }} ile {{ end_date }} arasındaki veriler gösteriliyor</p>

            <div class="central-legend">
                <div class="legend-item" title="Fiyat">
                    <div class="legend-color" style="background-color: rgba(0, 128, 0, 1);"></div>
                    <span>Fiyat</span>
                </div>
                <div class="legend-item" title="İndirimli fiyat. Market kartı indirimi de olabilir. Indirim mevcut değilse, normal fiyat kullanılır.">
                    <div class="legend-color" style="background-color: rgba(255, 159, 64, 1);"></div>
                    <span>İndirimli Fiyat</span>
                </div>
                <div class="legend-item" title="indirimli fiyattan hesaplanmıştır">
                    <div class="legend-color" style="background-color: rgba(255, 99, 132, 1);"></div>
                    <span>Medyan</span>
                </div>
                <div class="legend-item" title="indirimli fiyattan hesaplanmıştır">
                    <div class="legend-color" style="background-color: rgba(54, 162, 235, 1);"></div>
                    <span>Hareketli Ortalama (14 gün)</span>
                </div>
            </div>

            <div class="chart-grid">
                {% for chart_data in charts_data %}
                    <div class="chart-container">
                        <img src="{{ url_for('static', filename=chart_data.shop_logo) }}" alt="{{ chart_data.product_name }} logo" class="shop-logo">
                        <a href="{{ chart_data.url }}" target="_blank"><h3>{{ chart_data.product_name }}</h3></a>
                        <span class="product-category">{{ chart_data.search_term }} ({{ chart_data.product_category }})</span>
                        <canvas id="chart-{{ loop.index }}" width="400" height="200"></canvas>
                    </div>
                {% endfor %}
            </div>
            <div class="pagination-container">
                {% include '_pagination.html' %}
            </div>
        {% elif no_results %}
            <div class="no-results">
                <h2>Sonuç Bulunamadı</h2>
                <p>Seçilen kriterlere uygun veri bulunmamaktadır. Lütfen farklı bir market, kategori veya tarih aralığı deneyin.</p>
            </div>
        {% endif %}
    </main>
</div>

<div id="loading-overlay" style="display: none;">
    <div class="spinner"></div>
</div>

    {% if charts_data %}
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Sidebar toggle
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const sidebar = document.getElementById('filter-sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const overlay = document.getElementById('sidebar-overlay');
            const body = document.body;

            if (menuToggleBtn) {
                function openSidebar() {
                    sidebar.classList.add('active');
                    overlay.classList.add('active');
                    body.classList.add('sidebar-active');
                }

                function closeSidebar() {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                    body.classList.remove('sidebar-active');
                }

                menuToggleBtn.addEventListener('click', openSidebar);
                closeSidebarBtn.addEventListener('click', closeSidebar);
                overlay.addEventListener('click', closeSidebar);
            }

            // Litepicker
            new Litepicker({
                element: document.getElementById('date-range'),
                singleMode: false,
                format: 'YYYY-MM-DD',
                setup: (picker) => {
                    picker.on('selected', (date1, date2) => {
                        // your code
                    });
                }
            });

            // Charts
            {% if charts_data %}
                let charts = [];

                {% for chart_data in charts_data %}
                    var prices{{ loop.index }} = {{ chart_data.prices | tojson }};
                    var discountPrices{{ loop.index }} = {{ chart_data.discount_prices | tojson }};
                    var labels{{ loop.index }} = {{ chart_data.labels | tojson }};

                    // Calculate median
                    var sortedPrices = [...discountPrices{{ loop.index }}].sort((a, b) => a - b);
                    var mid = Math.floor(sortedPrices.length / 2);
                    var median = sortedPrices.length % 2 !== 0 ? sortedPrices[mid] : (sortedPrices[mid - 1] + sortedPrices[mid]) / 2;
                    var medianData = Array(prices{{ loop.index }}.length).fill(median);

                    // Calculate moving average on discount prices
                    var movingAvg = [];
                    var windowSize = 14;
                    for (var i = 0; i < discountPrices{{ loop.index }}.length; i++) {
                        if (i < windowSize - 1) {
                            movingAvg.push(null);
                        } else {
                            var sum = 0;
                            for (var j = 0; j < windowSize; j++) {
                                if(discountPrices{{ loop.index }}[i - j] !== null) {
                                    sum += discountPrices{{ loop.index }}[i - j];
                                }
                            }
                            movingAvg.push(sum / windowSize);
                        }
                    }

                    var ctx{{ loop.index }} = document.getElementById('chart-{{ loop.index }}').getContext('2d');
                    var chart{{ loop.index }} = new Chart(ctx{{ loop.index }}, {
                        type: 'line',
                        data: {
                            labels: labels{{ loop.index }},
                            datasets: [{
                                label: 'Fiyat',
                                data: prices{{ loop.index }},
                                borderColor: 'rgba(0, 128, 0, 1)',
                                borderWidth: 2,
                                stepped: true,
                                fill: false,
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                pointBackgroundColor: 'rgba(0, 128, 0, 1)'
                            }, {
                                label: 'İndirimli Fiyat',
                                data: discountPrices{{ loop.index }},
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 2,
                                stepped: true,
                                fill: false,
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                pointBackgroundColor: 'rgba(255, 159, 64, 1)'
                            }, {
                                label: 'Medyan',
                                data: medianData,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                            }, {
                                label: 'Hareketli Ortalama (14 gün)',
                                data: movingAvg,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0,
                            }]
                        },
                        options: {
                            scales: {
                                x: {
                                    ticks: {
                                        maxRotation: 90,
                                        minRotation: 80
                                    },
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value, index, values) {
                                            return Math.round(value) + ' TL';
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(200, 200, 200, 0.5)'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false,
                                    position: 'top',
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(context.parsed.y);
                                            }
                                            return label;
                                        }
                                    }
                                },
                                zoom: {
                                    pan: {
                                        enabled: true,
                                        mode: 'xy'
                                    },
                                    limits: {
                                        x: {min: 'original', max: 'original'},
                                        y: {min: 'original', max: 'original', minRange: 10}
                                    },
                                    zoom: {
                                        wheel: {
                                            enabled: true,
                                        },
                                        pinch: {
                                            enabled: true
                                        },
                                        mode: 'xy',
                                    }
                                }
                            }
                        }
                    });

                    charts.push(chart{{ loop.index }});

                    ctx{{ loop.index }}.canvas.ondblclick = function() {
                        chart{{ loop.index }}.resetZoom();
                    };
                {% endfor %}
            {% endif %}
        });
    </script>
{% endblock %}
