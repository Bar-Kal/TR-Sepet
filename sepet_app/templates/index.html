{% extends "base.html" %}

{% block title %}{{ title }} - My Flask App{% endblock %}

{% block content %}
    <div class="controls-section">
        <div class="container">
            <form action="/index" method="post">
                <div class="form-row">
                    <div class="form-group">
                        <label for="shop-select">Shop</label>
                        <select name="shop" id="shop-select">
                            {% for shop in shop_names %}
                                <option value="{{ shop }}" {% if shop == shop_name %}selected{% endif %}>{{ shop }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="category-select">Category</label>
                        <select name="category" id="category-select">
                            {% for category in food_categories %}
                                <option value="{{ category }}" {% if category == category_name %}selected{% endif %}>{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date" name="start_date" value="{{ start_date }}">
                    </div>
                    <div class="form-group">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date" name="end_date" value="{{ end_date }}">
                    </div>
                </div>
                <div class="form-actions">
                    <input type="submit" value="Analyze Prices">
                </div>
            </form>
        </div>
    </div>

    <div class="results-section">
        <div class="container">
            {% if charts_data %}
                <h2>{{ results_title }}</h2>
                <p class="date-range">Showing data from {{ start_date }} to {{ end_date }}</p>

                <div class="chart-grid">
                    {% for chart_data in charts_data %}
                        <div class="chart-container">
                            <a href="{{ chart_data.url }}" target="_blank"><h3>{{ chart_data.product_name }}</h3></a>
                            <canvas id="chart-{{ loop.index }}" width="400" height="200"></canvas>
                            <div class="info-grid">
                                <div class="info-box">
                                    <span class="info-title">En Düşük Fiyat</span>
                                    <span class="info-price">{{ chart_data.lowest_price }}</span>
                                </div>
                                <div class="info-box">
                                    <span class="info-title">En Yüksek Fiyat</span>
                                    <span class="info-price">{{ chart_data.highest_price }}</span>
                                </div>
                                <div class="info-box">
                                    <span class="info-title">Şu An En Ucuz Fiyat</span>
                                    <span class="info-price">{{ chart_data.current_cheapest_price }}</span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% elif no_results %}
                <div class="no-results">
                    <h2>No Results Found</h2>
                    <p>There is no data available for the selected criteria. Please try a different shop, category, or date range.</p>
                </div>
            {% endif %}
        </div>
    </div>

    {% if charts_data %}
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
        <script>
            {% for chart_data in charts_data %}
                var prices{{ loop.index }} = {{ chart_data.prices | tojson }};
                var labels{{ loop.index }} = {{ chart_data.labels | tojson }};

                // Calculate median
                var sortedPrices = [...prices{{ loop.index }}].sort((a, b) => a - b);
                var mid = Math.floor(sortedPrices.length / 2);
                var median = sortedPrices.length % 2 !== 0 ? sortedPrices[mid] : (sortedPrices[mid - 1] + sortedPrices[mid]) / 2;
                var medianData = Array(prices{{ loop.index }}.length).fill(median);

                // Calculate moving average
                var movingAvg = [];
                var windowSize = 14;
                for (var i = 0; i < prices{{ loop.index }}.length; i++) {
                    if (i < windowSize - 1) {
                        movingAvg.push(null);
                    } else {
                        var sum = 0;
                        for (var j = 0; j < windowSize; j++) {
                            sum += prices{{ loop.index }}[i - j];
                        }
                        movingAvg.push(sum / windowSize);
                    }
                }

                var ctx{{ loop.index }} = document.getElementById('chart-{{ loop.index }}').getContext('2d');
                var chart{{ loop.index }} = new Chart(ctx{{ loop.index }}, {
                    type: 'line',
                    data: {
                        labels: labels{{ loop.index }},
                        datasets: [{
                            label: 'Price',
                            data: prices{{ loop.index }},
                            backgroundColor: 'rgba(144, 238, 144, 0.2)',
                            borderColor: 'rgba(0, 128, 0, 1)',
                            borderWidth: 2,
                            stepped: true,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            pointBackgroundColor: 'rgba(0, 128, 0, 1)'
                        }, {
                            label: 'Median',
                            data: medianData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                        }, {
                            label: 'Moving Average (14 days)',
                            data: movingAvg,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                ticks: {
                                    maxRotation: 90,
                                    minRotation: 80
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value, index, values) {
                                        return Math.round(value) + ' TL';
                                    }
                                },
                                grid: {
                                    color: 'rgba(200, 200, 200, 0.5)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            },
                            zoom: {
                                pan: {
                                    enabled: true,
                                    mode: 'xy'
                                },
                                zoom: {
                                    wheel: {
                                        enabled: true,
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'xy',
                                }
                            }
                        }
                    }
                });
                
                ctx{{ loop.index }}.canvas.ondblclick = function() {
                    chart{{ loop.index }}.resetZoom();
                };

            {% endfor %}
        </script>
    {% endif %}
{% endblock %}
